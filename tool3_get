import sys
from PyQt5.QtWidgets import QApplication, QMainWindow, QVBoxLayout, QWidget, QLabel, QComboBox, QPushButton
from PyQt5.QtCore import QSettings, QTimer
import serial.tools.list_ports

class SerialPortTool(QMainWindow):
    def __init__(self):
        super().__init__()

        self.initUI()

        # Populate COM ports
        self.populateCOMPorts()

        # Load settings
        self.loadSettings()

        # Start timer to refresh COM ports every 5 seconds
        self.timer = QTimer()
        self.timer.timeout.connect(self.checkForCOMPortChanges)
        self.timer.start(5000)

        # Store initial COM ports for change detection
        self.previous_ports = self.getAvailableCOMPorts()

    def initUI(self):
        self.setWindowTitle('Serial Port Tool')

        self.centralWidget = QWidget()
        self.setCentralWidget(self.centralWidget)
        self.layout = QVBoxLayout(self.centralWidget)

        self.portLabel = QLabel('Select COM Port:')
        self.layout.addWidget(self.portLabel)

        self.portComboBox = QComboBox()
        self.layout.addWidget(self.portComboBox)

        self.baudRateLabel = QLabel('Select Baud Rate:')
        self.layout.addWidget(self.baudRateLabel)

        self.baudRateComboBox = QComboBox()
        self.baudRateComboBox.addItems(['9600', '19200', '38400', '57600', '115200'])
        self.layout.addWidget(self.baudRateComboBox)

    def getAvailableCOMPorts(self):
        return [port.device for port in serial.tools.list_ports.comports()]

    def populateCOMPorts(self):
        ports = self.getAvailableCOMPorts()
        self.portComboBox.clear()
        for port in ports:
            self.portComboBox.addItem(port)

    def checkForCOMPortChanges(self):
        current_ports = self.getAvailableCOMPorts()
        if set(current_ports) != set(self.previous_ports):
            self.populateCOMPorts()
            self.previous_ports = current_ports

    def loadSettings(self):
        settings = QSettings('MyCompany', 'SerialPortTool')
        com_port = settings.value('com_port', '')
        baud_rate = settings.value('baud_rate', '9600')

        # Check if the saved com_port is in the current list of ports
        index = self.portComboBox.findText(com_port)
        if index != -1:
            self.portComboBox.setCurrentIndex(index)
        else:
            # If not found, select the first available port or leave empty if no ports are available
            if self.portComboBox.count() > 0:
                self.portComboBox.setCurrentIndex(0)

        index = self.baudRateComboBox.findText(baud_rate)
        if index != -1:
            self.baudRateComboBox.setCurrentIndex(index)

    def saveSettings(self, com_port, baud_rate):
        settings = QSettings('MyCompany', 'SerialPortTool')
        settings.setValue('com_port', com_port)
        settings.setValue('baud_rate', baud_rate)

    def closeEvent(self, event):
        # Save settings when closing the application
        com_port = self.portComboBox.currentText()
        baud_rate = self.baudRateComboBox.currentText()
        self.saveSettings(com_port, baud_rate)
        event.accept()

if __name__ == '__main__':
    app = QApplication(sys.argv)
    window = SerialPortTool()
    window.show()
    sys.exit(app.exec_())
